<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>KheshigMate Odası - <%= project.name %></title>
    <meta name="description" content="KheshigMate Elite Proje Odası">
    <meta name="viewport" content="width=device-width, initial-scale=1">    <link rel="stylesheet" href="/css/style.css?v=6.0.0">
      <!-- FullCalendar CSS (Yerel) -->
    <link rel="stylesheet" href="/css/fullcalendar.min.css">
    
    <!-- Quill.js Rich Text Editor CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.6/quill.snow.min.css">
    
    <!-- BPMN.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.7.1/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.7.1/dist/assets/bpmn-font/css/bpmn-embedded.css">
    <script src="https://kit.fontawesome.com/6510466b6c.js" crossorigin="anonymous"></script><script>
        const ROOM_ID = "<%= project._id %>";
        const USER_USERNAME = "<%= user.username %>";
        const USER_ID = "<%= user._id %>";
    </script>
</head>

<body class="room-page">
    <!-- Modern Header Bar -->
    <div class="room-header">        <div class="room-header-left">
            <div class="room-logo">
                <i class="fas fa-horse-head"></i>
                KheshigMate
            </div>
            <div class="room-project-info">
                <span class="room-project-name"><%= project.name %></span>
                <span class="room-code-display">
                    <i class="fas fa-key"></i>
                    Kheshig Kodu: <%= project._id %>
                    <button class="copy-code-btn" onclick="copyRoomId()" title="Kodu Kopyala">
                        <i class="fas fa-copy"></i>
                    </button>
                </span>
            </div>
        </div>
        <div class="room-header-right">
            <button class="header-btn dashboard-btn" id="dashboard-redirect-btn" title="Kontrol Paneline Dön">
                <i class="fas fa-tachometer-alt"></i>
                Panel
            </button>
        </div>
    </div>

    <div class="overlay" id="overlay" style="display: none;">
        <div class="box modern-box">
            <div class="head-name">Kullanıcı Adı</div>
            <input type="text" class="name-field modern-input" id="name-field" value="<%= user.username %>" readonly>
            <button class="continue-name primary-btn">Devam Et</button>
        </div>
    </div>

    <div class="modern-room-container">        <div class="video-section">            <div class="video-container-modern" id="vcont">
                <div class="video-box-modern">
                    <video class="video-frame-modern" id="vd1" autoplay playsinline></video>
                    <div class="video-overlay">
                        <div class="nametag-modern" id="myname"><%= user.username %></div>
                        <div class="mute-icon-modern" id="mymuteicon"><i class="fas fa-microphone-slash"></i></div>
                        <div class="video-off-modern" id="myvideooff">
                            <i class="fas fa-video-slash"></i>
                            <span>Video Kapalı</span>
                        </div>
                    </div>
                </div>
                  <!-- Whiteboard overlay -->
                <div class="whiteboard-section">
                    <div class="whiteboard-container">
                        <canvas id="whiteboard" height="800" width="1200"></canvas>
                        <div class="whiteboard-tools">
                            <div class="tool-category">
                                <span class="tool-label">Renkler</span>
                                <div class="color-palette">
                                    <div class="color-option black" onclick="setColor('black')" title="Siyah"></div>
                                    <div class="color-option red" onclick="setColor('#e74c3c')" title="Kırmızı"></div>
                                    <div class="color-option yellow" onclick="setColor('#f1c40f')" title="Sarı"></div>
                                    <div class="color-option green" onclick="setColor('#27ae60')" title="Yeşil"></div>
                                    <div class="color-option blue" onclick="setColor('#3498db')" title="Mavi"></div>
                                    <div class="color-option orange" onclick="setColor('#e67e22')" title="Turuncu"></div>
                                    <div class="color-option purple" onclick="setColor('#9b59b6')" title="Mor"></div>
                                    <div class="color-option pink" onclick="setColor('#fd79a8')" title="Pembe"></div>
                                </div>
                            </div>
                            <div class="tool-category">
                                <span class="tool-label">Araçlar</span>
                                <div class="tool-buttons">
                                    <button class="tool-btn" onclick="setEraser()" title="Silgi">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                    <button class="tool-btn clear-btn" onclick="clearBoard()" title="Temizle">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BPMN Workflow Editor Overlay -->
                <div class="bpmn-main-editor" id="bpmn-main-editor" style="display: none;">
                    <div class="bpmn-editor-overlay">
                        <div class="bpmn-editor-header">
                            <div class="bpmn-editor-title">
                                <h3><i class="fas fa-project-diagram"></i> İş Akışı Editörü</h3>
                                <span class="current-diagram-name" id="current-diagram-name">Yeni Diyagram</span>
                            </div>
                            <div class="bpmn-editor-controls">
                                <button id="save-main-diagram-btn" class="btn btn-success" disabled>
                                    <i class="fas fa-save"></i> Kaydet
                                </button>
                                <button id="export-main-diagram-btn" class="btn btn-info" disabled>
                                    <i class="fas fa-download"></i> Dışa Aktar
                                </button>
                                <button id="fullscreen-bpmn-btn" class="btn btn-secondary">
                                    <i class="fas fa-expand"></i> Tam Ekran
                                </button>
                                <button id="close-bpmn-editor-btn" class="btn btn-danger">
                                    <i class="fas fa-times"></i> Kapat
                                </button>
                            </div>
                        </div>
                        
                        <div class="bpmn-main-canvas-container">
                            <div class="bpmn-main-canvas" id="bpmn-main-canvas">
                                <!-- BPMN.io editor will be rendered here -->
                            </div>
                        </div>
                        
                        <div class="bpmn-main-status" id="bpmn-main-status">
                            <span class="status-text">Editör hazır</span>
                            <div class="zoom-controls">
                                <button id="zoom-in-btn" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button id="zoom-out-btn" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button id="zoom-fit-btn" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-buttons">
                    <button class="control-btn audio-btn tooltip" data-tooltip="Sesi Aç/Kapat">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-btn video-btn tooltip" data-tooltip="Videoyu Aç/Kapat">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="control-btn screenshare-btn tooltip" data-tooltip="Ekran Paylaş">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button class="control-btn whiteboard-btn tooltip" data-tooltip="Beyaz Tahta">
                        <i class="fas fa-chalkboard"></i>
                    </button>
                    <button class="control-btn disconnect-btn tooltip" data-tooltip="Ayrıl">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>        </div>

        <div class="sidebar-panel">
            <div class="sidebar-header">
                <div class="project-title-modern">
                    <i class="fas fa-project-diagram"></i>
                    <%= project.name %>
                </div>                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="chat">
                        <i class="fas fa-comment-alt"></i>
                        <span>Sohbet</span>
                    </button>                    <button class="sidebar-tab" data-tab="tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Görevler</span>
                    </button>                    <button class="sidebar-tab" data-tab="gantt">
                        <i class="fas fa-chart-gantt"></i>
                        <span>Zaman Çizelgesi</span>
                    </button>
                    <button class="sidebar-tab" data-tab="calendar">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Takvim</span>
                    </button>
                    <button class="sidebar-tab" data-tab="workflow">
                        <i class="fas fa-project-diagram"></i>
                        <span>İş Akışı</span>
                    </button>
                    <button class="sidebar-tab" data-tab="notes">
                        <i class="fas fa-sticky-note"></i>
                        <span>Notlar</span>
                    </button>
                    <button class="sidebar-tab" data-tab="attendees">
                        <i class="fas fa-users"></i>
                        <span>Katılımcılar</span>
                    </button>
                </div>
            </div>

            <div class="sidebar-content">
                <div class="tab-panel active" id="chat-tab">
                    <div class="chat-messages" id="chat-cont"></div>
                    <div class="chat-input-section">
                        <div class="chat-input-wrapper">
                            <input type="text" class="chat-input-modern" placeholder="Mesaj yazın..." id="chat-input">
                            <button class="chat-send-btn" id="chat-send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>                <div class="tab-panel" id="notes-tab">
                    <div class="quill-notes-container">
                        <div class="notes-header-quill">
                            <div class="notes-title">
                                <i class="fas fa-feather-alt"></i>
                                Notlar
                            </div>
                            <div class="notes-actions">
                                <button id="add-note-btn-quill" class="add-note-btn-quill">
                                    <i class="fas fa-plus"></i>
                                    Yeni Not Ekle
                                </button>
                            </div>
                        </div>
                        <div class="notes-list-quill" id="notes-list-quill">
                            <!-- Rich text notes will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Tasks Tab Panel (Kanban Board) -->
                <div class="tab-panel" id="tasks-tab">
                    <div id="kanban-board" class="kanban-content">
                        <div class="kanban-header">
                            <h3>📋 Görev Tahtası</h3>
                            <button id="add-task-btn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Yeni Görev
                            </button>
                        </div>
                        
                        <div class="kanban-container">
                            <div class="kanban-column" data-status="todo">
                                <div class="column-header">
                                    <h4>📝 Yapılacaklar</h4>
                                    <span class="task-count" id="todo-count">0</span>
                                </div>
                                <div class="column-content" id="todo-column">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="kanban-column" data-status="in-progress">
                                <div class="column-header">
                                    <h4>⚡ Devam Ediyor</h4>
                                    <span class="task-count" id="in-progress-count">0</span>
                                </div>
                                <div class="column-content" id="in-progress-column">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="kanban-column" data-status="done">
                                <div class="column-header">
                                    <h4>✅ Tamamlandı</h4>
                                    <span class="task-count" id="done-count">0</span>
                                </div>
                                <div class="column-content" id="done-column">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>                        </div>

                        <!-- AI Task Suggestions Panel -->
                        <div class="ai-suggestions-panel">
                            <div class="ai-panel-header">
                                <div class="ai-title">
                                    <span class="ai-icon">✨</span>
                                    Akıllı Öneriler
                                </div>
                                <div class="ai-controls">
                                    <button id="ai-refresh-btn" class="ai-refresh-btn">
                                        <i class="fas fa-sync-alt"></i>
                                        Önerileri Yükle
                                    </button>
                                </div>
                            </div>
                            
                            <div id="ai-status" class="ai-status empty">
                                <!-- Status messages will be shown here -->
                            </div>
                            
                            <div id="ai-suggestions-list" class="ai-suggestions-list" style="display: none;">
                                <!-- AI suggestions will be rendered here -->
                            </div>
                        </div>
                    </div>                </div>                <!-- Workflow Tab Panel (BPMN Control Panel) -->
                <div class="tab-panel" id="workflow-tab">
                    <div class="workflow-control-panel">
                        <div class="workflow-control-header">
                            <div class="workflow-title">
                                <h3><i class="fas fa-project-diagram"></i> İş Akışı Yönetimi</h3>
                            </div>
                        </div>
                        
                        <div class="workflow-control-actions">
                            <button id="open-bpmn-editor-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-edit"></i> Diyagram Editörünü Aç
                            </button>
                            <button id="new-diagram-btn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Yeni Diyagram
                            </button>
                        </div>
                        
                        <div class="diagram-list-section" id="diagram-list-section">
                            <div class="diagram-list-header">
                                <h4><i class="fas fa-folder-open"></i> Mevcut Diyagramlar</h4>
                                <button id="refresh-diagram-list" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="diagram-list" id="diagram-list">
                                <!-- Diagrams will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="workflow-status" id="workflow-status">
                            <span class="status-text">Hazır</span>
                            <div class="collaboration-indicators" id="collaboration-indicators">
                                <!-- Real-time collaboration indicators -->
                            </div>
                        </div>
                    </div>                </div>

                <!-- Gantt Chart Tab Panel -->
                <div class="tab-panel" id="gantt-tab">
                    <div class="gantt-control-panel">
                        <div class="gantt-header">
                            <h3><i class="fas fa-chart-gantt"></i> Zaman Çizelgesi</h3>
                            <div class="gantt-view-controls">
                                <button id="gantt-day-view" class="view-btn active" data-view="Day">Gün</button>
                                <button id="gantt-week-view" class="view-btn" data-view="Week">Hafta</button>
                                <button id="gantt-month-view" class="view-btn" data-view="Month">Ay</button>
                            </div>
                        </div>
                          <div class="gantt-chart-container" id="gantt-chart-container">
                            <div id="gantt-chart"></div>
                        </div>
                        
                        <div class="gantt-status">
                            <span class="status-text">Gantt şeması yükleniyor...</span>
                        </div>
                    </div>                </div>                <!-- Calendar Tab Panel -->
                <div class="tab-panel" id="calendar-tab">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h2><i class="fas fa-calendar-alt icon"></i>Proje Takvimi</h2>
                            <button class="new-event-btn">
                                <i class="fas fa-plus"></i>
                                Yeni Etkinlik
                            </button>
                        </div>
                        <div id="calendar"></div>
                    </div>
                </div>

                <div class="tab-panel" id="attendees-tab">
                    <div class="attendees-list-modern" id="attendees-list"></div>
                </div>
            </div>
        </div>    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/bpmn-js@17.7.1/dist/bpmn-modeler.development.js"></script>
    <script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    
    <!-- Quill.js Rich Text Editor JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.6/quill.min.js"></script>
    
    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>    <script src="/js/calendar.js?v=<%= Date.now() %>&r=<%= Math.random() %>"></script>
    <script src="/js/kanban.js?v=<%= Date.now() %>&r=<%= Math.random() %>"></script>
    <script src="/js/ai-suggestions.js?v=<%= Date.now() %>&r=<%= Math.random() %>"></script>
    <script src="/js/bpmn.js?v=<%= Date.now() %>&r=<%= Math.random() %>"></script><!-- ✅ Quill.js Rich Text Notes Manager -->
    <script src="/js/quill-notes.js?v=<%= Date.now() %>&r=<%= Math.random() %>"></script>
    
    <!-- CRITICAL: Multi-Strategy Gantt.js Loading System -->
    <script>
        console.log('🔄 MULTI-STRATEGY GANTT LOADING SYSTEM STARTING...');
        window.GANTT_FORCE_LOAD_STARTED = true;
        window.GANTT_LOAD_TIMESTAMP = '20250609050835';
        window.GANTT_LOADING_STRATEGIES = {
            scriptTag: false,
            dynamic: false,
            inline: false,
            fallback: false
        };
    </script>
    
    <!-- Strategy 1: Normal script tag with aggressive cache busting -->
    <script src="/js/gantt.js?v=20250609050835&nocache=true&force=1&bust=20250609050835&strategy=1" 
            onload="console.log('✅ GANTT SCRIPT TAG LOADED'); window.GANTT_LOADING_STRATEGIES.scriptTag = true;"
            onerror="console.error('❌ GANTT SCRIPT TAG FAILED'); window.GANTT_LOADING_STRATEGIES.scriptTag = false;"></script>
    
    <!-- Strategy 2: Dynamic loading as immediate backup -->
    <script>
        setTimeout(function() {
            if (!window.GANTT_FILE_COMPLETED && !window.GanttManager) {
                console.log('🔄 STRATEGY 2: Dynamic loading gantt.js');
                var script = document.createElement('script');
                script.src = '/js/gantt.js?dynamic=true&v=20250609050835&nocache=true&force=2&strategy=2';
                script.onload = function() {
                    console.log('✅ DYNAMIC GANTT LOADED');
                    window.GANTT_LOADING_STRATEGIES.dynamic = true;
                };
                script.onerror = function() {
                    console.error('❌ DYNAMIC GANTT FAILED');
                    window.GANTT_LOADING_STRATEGIES.dynamic = false;
                };
                document.head.appendChild(script);
            }
        }, 500);
    </script>
    
    <!-- Strategy 3: Inline fetch and eval -->
    <script>
        setTimeout(function() {
            if (!window.GANTT_FILE_COMPLETED && !window.GanttManager) {
                console.log('🔄 STRATEGY 3: Inline fetch and execute');
                fetch('/js/gantt.js?inline=true&v=20250609050835&nocache=true&force=3&strategy=3')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.text();
                    })
                    .then(code => {
                        console.log('📄 Got gantt.js content (' + code.length + ' chars), executing...');
                        try {
                            // Create a script element for better error handling
                            var script = document.createElement('script');
                            script.text = code;
                            document.head.appendChild(script);
                            console.log('✅ INLINE EXECUTION SUCCESS');
                            window.GANTT_LOADING_STRATEGIES.inline = true;
                        } catch (error) {
                            console.error('❌ INLINE EXECUTION ERROR:', error);
                            window.GANTT_LOADING_STRATEGIES.inline = false;
                        }
                    })
                    .catch(error => {
                        console.error('❌ FETCH ERROR:', error);
                        window.GANTT_LOADING_STRATEGIES.inline = false;
                    });
            }
        }, 1000);
    </script>
    
    <!-- Strategy 4: Ultimate fallback with different URL pattern -->
    <script>
        setTimeout(function() {
            if (!window.GANTT_FILE_COMPLETED && !window.GanttManager) {
                console.log('🔄 STRATEGY 4: Ultimate fallback loading');
                var script = document.createElement('script');
                script.src = '/js/gantt.js?fallback=true&timestamp=' + Date.now() + '&random=' + Math.random() + '&strategy=4';
                script.onload = function() {
                    console.log('✅ FALLBACK GANTT LOADED');
                    window.GANTT_LOADING_STRATEGIES.fallback = true;
                };
                script.onerror = function() {
                    console.error('❌ ALL GANTT LOADING STRATEGIES FAILED!');
                    window.GANTT_LOADING_STRATEGIES.fallback = false;
                };
                document.head.appendChild(script);
            }
        }, 2000);
    </script>
    
    <!-- Comprehensive verification and status report -->
    <script>
        setTimeout(() => {
            console.log('\n=== GANTT LOADING FINAL REPORT ===');
            console.log('📊 Frappe Gantt library:', typeof window.Gantt !== 'undefined' ? '✅ Available' : '❌ Missing');
            console.log('📊 GanttManager class:', typeof window.GanttManager !== 'undefined' ? '✅ Available' : '❌ Missing');
            console.log('📊 File loading marker:', window.GANTT_FILE_LOADING ? '✅ Set' : '❌ Not set');
            console.log('📊 File completion marker:', window.GANTT_FILE_COMPLETED ? '✅ Set' : '❌ Not set');
            console.log('📊 Loading strategies:');
            console.log('   - Script Tag:', window.GANTT_LOADING_STRATEGIES.scriptTag ? '✅' : '❌');
            console.log('   - Dynamic:', window.GANTT_LOADING_STRATEGIES.dynamic ? '✅' : '❌');
            console.log('   - Inline:', window.GANTT_LOADING_STRATEGIES.inline ? '✅' : '❌');
            console.log('   - Fallback:', window.GANTT_LOADING_STRATEGIES.fallback ? '✅' : '❌');
            
            // List all gantt-related window properties
            const ganttProps = Object.keys(window).filter(key => 
                key.toLowerCase().includes('gantt')
            ).sort();
            console.log('📊 Window properties with "gantt":', ganttProps);
            
            if (!window.GanttManager) {
                console.error('\n❌ CRITICAL: GanttManager still not available after ALL strategies!');
                console.error('🔧 NEXT STEPS:');
                console.error('   1. Check Network tab in DevTools for failed requests');
                console.error('   2. Clear ALL browser data (cache, cookies, storage)');
                console.error('   3. Try incognito/private browsing mode');
                console.error('   4. Check if gantt.js file exists and is accessible');
                
                // Show user-friendly alert
                alert('🚨 GANTT ŞEMASı YÜKLENEMEDİ!\n\n' +
                      'Tüm yükleme stratejileri başarısız oldu.\n\n' +
                      'Çözüm adımları:\n' +
                      '1. CTRL+Shift+R ile hard refresh yapın\n' +
                      '2. Browser\'ın TÜM verilerini temizleyin\n' +
                      '3. Gizli/özel pencerede deneyin\n' +
                      '4. Developer Tools > Network sekmesini kontrol edin');
            } else {
                console.log('✅ SUCCESS: GanttManager is available!');
                console.log('🎉 Gantt chart should work properly now');
            }
        }, 5000);
    </script>
    <script src="/js/room.js?v=<%= Date.now() %>&r=<%= Math.random() %>"></script>
    
    <script>
        // Odaya geri dönmek için buton
        const dashboardRedirectBtn = document.getElementById('dashboard-redirect-btn');
        if(dashboardRedirectBtn){
            dashboardRedirectBtn.addEventListener('click', () => {
                window.location.href = '/dashboard';
            });
        }

        function copyRoomId() {
            const roomId = "<%= project._id %>";
            navigator.clipboard.writeText(roomId).then(() => {
                // Modern notification
                showNotification("Oda kodu kopyalandı!", "success");
            }).catch(err => {
                console.error('Oda kodu kopyalanamadı: ', err);
                showNotification("Kopyalama başarısız oldu.", "error");
            });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }        // Kanban Board Initialization
        window.roomKanbanBoard = null;
        window.kanbanInitialized = false;
          // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Immediately hide task modal on page load
            const taskModal = document.getElementById('task-modal');
            if (taskModal) {
                taskModal.style.display = 'none';
                taskModal.style.visibility = 'hidden';
                taskModal.style.opacity = '0';
                taskModal.classList.remove('show');
                console.log('🔒 Task modal forcefully hidden on DOM ready');
            }
            
            // Only initialize kanban when tasks tab is clicked, not automatically
            const tasksTab = document.querySelector('[data-tab="tasks"]');
            if (tasksTab) {
                tasksTab.addEventListener('click', () => {
                    // Hide modal again before initializing kanban
                    if (taskModal) {
                        taskModal.style.display = 'none';
                        taskModal.style.visibility = 'hidden';
                        taskModal.style.opacity = '0';
                        taskModal.classList.remove('show');
                    }
                      // Only initialize once and when socket is ready
                    if (!window.kanbanInitialized && window.socket && window.KanbanBoard) {                        try {
                            console.log('🎯 Initializing Kanban board on first tasks tab click');
                            window.roomKanbanBoard = new KanbanBoard('<%= project._id %>', window.socket);
                            window.kanbanInitialized = true;
                            console.log('✅ Kanban board initialized successfully');
                            
                            // AI suggestions will be automatically initialized by KanbanBoard.initializeAISuggestions()
                        } catch (error) {
                            console.error('❌ Kanban initialization failed:', error);
                        }
                    }
                });
            }
        });
    </script>    <!-- Task Modal -->
    <div id="task-modal" class="modal" style="display: none !important; visibility: hidden !important; opacity: 0 !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Yeni Görev</h3>
                <span class="close" id="close-task-modal">&times;</span>
            </div>
            <form id="task-form">
                <div class="form-group">
                    <label for="task-title">Görev Başlığı *</label>
                    <input type="text" id="task-title" name="title" required maxlength="200">
                </div>
                
                <div class="form-group">
                    <label for="task-description">Açıklama</label>
                    <textarea id="task-description" name="description" rows="4" maxlength="1000"></textarea>
                </div>
                  <div class="form-row">
                    <div class="form-group">
                        <label for="task-priority">Öncelik</label>
                        <select id="task-priority" name="priority">
                            <option value="low">Düşük</option>
                            <option value="medium" selected>Orta</option>
                            <option value="high">Yüksek</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="task-start-date">Başlangıç Tarihi</label>
                        <input type="date" id="task-start-date" name="startDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="task-due-date">Bitiş Tarihi</label>
                        <input type="date" id="task-due-date" name="dueDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="task-assigned-to">Atanan Kişi</label>
                    <select id="task-assigned-to" name="assignedTo">
                        <option value="">Atanmamış</option>
                        <!-- Project members will be loaded here -->
                    </select>
                </div>
                  <div class="form-group">
                    <label for="task-skills">Gereken Yetenekler</label>
                    <input type="text" id="task-skills" name="requiredSkills" 
                           placeholder="JavaScript, React, CSS... (virgülle ayırın)">
                </div>
            </form>
              <div class="modal-actions">
                <button type="button" id="cancel-task-btn" class="btn btn-secondary">İptal</button>
                <button type="button" id="save-task-btn" class="btn btn-primary">Kaydet</button>
                <button type="button" id="delete-task-btn" class="btn btn-danger" style="display: none;">Sil</button>
            </div>
        </div>
    </div>

    <!-- BPMN Diagram Creation Modal -->
    <div id="bpmn-create-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-project-diagram"></i> Yeni İş Akışı Diyagramı</h3>
                <button type="button" class="modal-close" id="close-bpmn-create-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="bpmn-create-form">
                <div class="form-group">
                    <label for="bpmn-diagram-name">Diyagram Adı *</label>
                    <input type="text" id="bpmn-diagram-name" name="name" required 
                           placeholder="Diyagram adını giriniz" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="bpmn-diagram-description">Açıklama</label>
                    <textarea id="bpmn-diagram-description" name="description" 
                              placeholder="Diyagram açıklamasını giriniz (isteğe bağlı)" 
                              rows="4" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="bpmn-diagram-category">Kategori</label>
                    <select id="bpmn-diagram-category" name="category">
                        <option value="general">Genel İş Akışı</option>
                        <option value="approval">Onay Süreci</option>
                        <option value="development">Geliştirme Süreci</option>
                        <option value="testing">Test Süreci</option>
                        <option value="deployment">Dağıtım Süreci</option>
                        <option value="other">Diğer</option>
                    </select>
                </div>
            </form>
              <div class="modal-actions">
                <button type="button" id="cancel-bpmn-create-btn" class="btn btn-secondary">İptal</button>
                <button type="button" id="create-bpmn-diagram-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Diyagram Oluştur
                </button>
            </div>
        </div>
    </div>

    <!-- BPMN Diagram Edit Modal -->
    <div id="bpmn-edit-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Diyagram Düzenle</h3>
                <button type="button" class="modal-close" id="close-bpmn-edit-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="bpmn-edit-form">
                <div class="form-group">
                    <label for="bpmn-edit-diagram-name">Diyagram Adı *</label>
                    <input type="text" id="bpmn-edit-diagram-name" name="name" required 
                           placeholder="Diyagram adını giriniz" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="bpmn-edit-diagram-description">Açıklama</label>
                    <textarea id="bpmn-edit-diagram-description" name="description" 
                              placeholder="Diyagram açıklamasını giriniz (isteğe bağlı)" 
                              rows="4" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="bpmn-edit-diagram-category">Kategori</label>
                    <select id="bpmn-edit-diagram-category" name="category">
                        <option value="general">Genel İş Akışı</option>
                        <option value="approval">Onay Süreci</option>
                        <option value="development">Geliştirme Süreci</option>
                        <option value="testing">Test Süreci</option>
                        <option value="deployment">Dağıtım Süreci</option>
                        <option value="other">Diğer</option>
                    </select>
                </div>
            </form>
            
            <div class="modal-actions">
                <button type="button" id="cancel-bpmn-edit-btn" class="btn btn-secondary">İptal</button>
                <button type="button" id="update-bpmn-diagram-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Değişiklikleri Kaydet
                </button>
            </div>        </div>
    </div>

    <!-- Calendar Event Modal -->
    <div id="eventModal" class="modal" style="display: none;">
        <div class="modal-content event-modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calendar-plus icon"></i>Yeni Etkinlik</h3>
                <button type="button" class="close-btn" onclick="window.calendarManager?.closeEventModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="eventForm">
                <div class="form-group">
                    <label for="eventTitle">Etkinlik Başlığı *</label>
                    <input type="text" id="eventTitle" name="title" required maxlength="200" 
                           placeholder="Etkinlik başlığını giriniz">
                </div>
                
                <div class="form-group">
                    <label for="eventDescription">Açıklama</label>
                    <textarea id="eventDescription" name="description" rows="3" maxlength="1000"
                              placeholder="Etkinlik açıklamasını giriniz (isteğe bağlı)"></textarea>
                </div>
                
                <div class="form-group">
                    <div class="datetime-row">
                        <div>
                            <label for="eventStartDate">Başlangıç Tarihi ve Saati *</label>
                            <input type="datetime-local" id="eventStartDate" name="startDate" required>
                        </div>
                        <div>
                            <label for="eventEndDate">Bitiş Tarihi ve Saati *</label>
                            <input type="datetime-local" id="eventEndDate" name="endDate" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="eventAllDay" name="allDay">
                        <label for="eventAllDay">Tüm gün</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="eventType">Etkinlik Türü</label>
                    <select id="eventType" name="type">
                        <option value="event">Genel Etkinlik</option>
                        <option value="meeting">Toplantı</option>
                        <option value="deadline">Son Tarih</option>
                        <option value="milestone">Kilometre Taşı</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="eventColor">Renk</label>
                    <input type="color" id="eventColor" name="color" value="#3498db">
                </div>
            </form>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="window.calendarManager?.closeEventModal()">İptal</button>
                <button type="button" class="btn btn-primary" onclick="window.calendarManager?.handleEventFormSubmit()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Quill Rich Text Editor Modal -->
    <div id="quill-editor-modal" class="note-editor-quill" style="display: none;">
        <div class="editor-container">
            <div class="editor-header">
                <div class="editor-title">
                    <i class="fas fa-feather-alt"></i>
                    <span id="editor-modal-title">Yeni Not</span>
                </div>
                <div class="editor-actions">
                    <button id="save-quill-note-btn" class="editor-btn save">
                        <i class="fas fa-save"></i>
                        Kaydet
                    </button>
                    <button id="cancel-quill-note-btn" class="editor-btn cancel">
                        <i class="fas fa-times"></i>
                        İptal
                    </button>
                </div>
            </div>
            
            <div class="editor-content">
                <div class="editor-input-group">
                    <label for="note-title-input">Not Başlığı (İsteğe bağlı)</label>
                    <input type="text" id="note-title-input" class="note-title-input" 
                           placeholder="Not başlığını giriniz..." maxlength="100">
                </div>
                
                <div class="editor-input-group">
                    <label>Not İçeriği</label>
                    <div id="quill-editor-container" class="quill-editor-container">
                        <!-- Quill editor will be initialized here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
