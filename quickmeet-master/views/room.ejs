<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>KheshigMate Odası - <%= project.name %></title>
    <meta name="description" content="KheshigMate Elite Proje Odası">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css?v=6.0.0">
    <script src="https://kit.fontawesome.com/6510466b6c.js" crossorigin="anonymous"></script>
    <!-- Oda ve kullanıcı bilgilerini JavaScript'e aktar -->
    <script>
        const ROOM_ID = "<%= project._id %>";
        const USER_USERNAME = "<%= user.username %>";
        const USER_ID = "<%= user._id %>";
    </script>
</head>

<body class="room-page">
    <!-- Modern Header Bar -->
    <div class="room-header">        <div class="room-header-left">
            <div class="room-logo">
                <i class="fas fa-horse-head"></i>
                KheshigMate
            </div>
            <div class="room-project-info">
                <span class="room-project-name"><%= project.name %></span>
                <span class="room-code-display">
                    <i class="fas fa-key"></i>
                    Kheshig Kodu: <%= project._id %>
                    <button class="copy-code-btn" onclick="copyRoomId()" title="Kodu Kopyala">
                        <i class="fas fa-copy"></i>
                    </button>
                </span>
            </div>
        </div>
        <div class="room-header-right">
            <button class="header-btn dashboard-btn" id="dashboard-redirect-btn" title="Kontrol Paneline Dön">
                <i class="fas fa-tachometer-alt"></i>
                Panel
            </button>
        </div>
    </div>

    <div class="overlay" id="overlay" style="display: none;">
        <div class="box modern-box">
            <div class="head-name">Kullanıcı Adı</div>
            <input type="text" class="name-field modern-input" id="name-field" value="<%= user.username %>" readonly>
            <button class="continue-name primary-btn">Devam Et</button>
        </div>
    </div>

    <div class="modern-room-container">        <div class="video-section">            <div class="video-container-modern" id="vcont">
                <div class="video-box-modern">
                    <video class="video-frame-modern" id="vd1" autoplay playsinline></video>
                    <div class="video-overlay">
                        <div class="nametag-modern" id="myname"><%= user.username %></div>
                        <div class="mute-icon-modern" id="mymuteicon"><i class="fas fa-microphone-slash"></i></div>
                        <div class="video-off-modern" id="myvideooff">
                            <i class="fas fa-video-slash"></i>
                            <span>Video Kapalı</span>
                        </div>
                    </div>
                </div>
                
                <!-- Whiteboard overlay -->
                <div class="whiteboard-section">
                    <div class="whiteboard-container">
                        <canvas id="whiteboard" height="800" width="1200"></canvas>
                        <div class="whiteboard-tools">
                            <div class="tool-category">
                                <span class="tool-label">Renkler</span>
                                <div class="color-palette">
                                    <div class="color-option black" onclick="setColor('black')" title="Siyah"></div>
                                    <div class="color-option red" onclick="setColor('#e74c3c')" title="Kırmızı"></div>
                                    <div class="color-option yellow" onclick="setColor('#f1c40f')" title="Sarı"></div>
                                    <div class="color-option green" onclick="setColor('#27ae60')" title="Yeşil"></div>
                                    <div class="color-option blue" onclick="setColor('#3498db')" title="Mavi"></div>
                                    <div class="color-option orange" onclick="setColor('#e67e22')" title="Turuncu"></div>
                                    <div class="color-option purple" onclick="setColor('#9b59b6')" title="Mor"></div>
                                    <div class="color-option pink" onclick="setColor('#fd79a8')" title="Pembe"></div>
                                </div>
                            </div>
                            <div class="tool-category">
                                <span class="tool-label">Araçlar</span>
                                <div class="tool-buttons">
                                    <button class="tool-btn" onclick="setEraser()" title="Silgi">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                    <button class="tool-btn clear-btn" onclick="clearBoard()" title="Temizle">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-buttons">
                    <button class="control-btn audio-btn tooltip" data-tooltip="Sesi Aç/Kapat">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-btn video-btn tooltip" data-tooltip="Videoyu Aç/Kapat">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="control-btn screenshare-btn tooltip" data-tooltip="Ekran Paylaş">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button class="control-btn whiteboard-btn tooltip" data-tooltip="Beyaz Tahta">
                        <i class="fas fa-chalkboard"></i>
                    </button>
                    <button class="control-btn disconnect-btn tooltip" data-tooltip="Ayrıl">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>        </div>

        <div class="sidebar-panel">
            <div class="sidebar-header">
                <div class="project-title-modern">
                    <i class="fas fa-project-diagram"></i>
                    <%= project.name %>
                </div>                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="chat">
                        <i class="fas fa-comment-alt"></i>
                        <span>Sohbet</span>
                    </button>
                    <button class="sidebar-tab" data-tab="tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Görevler</span>
                    </button>
                    <button class="sidebar-tab" data-tab="workflow">
                        <i class="fas fa-project-diagram"></i>
                        <span>İş Akışı</span>
                    </button>
                    <button class="sidebar-tab" data-tab="notes">
                        <i class="fas fa-sticky-note"></i>
                        <span>Notlar</span>
                    </button>
                    <button class="sidebar-tab" data-tab="attendees">
                        <i class="fas fa-users"></i>
                        <span>Katılımcılar</span>
                    </button>
                </div>
            </div>

            <div class="sidebar-content">
                <div class="tab-panel active" id="chat-tab">
                    <div class="chat-messages" id="chat-cont"></div>
                    <div class="chat-input-section">
                        <div class="chat-input-wrapper">
                            <input type="text" class="chat-input-modern" placeholder="Mesaj yazın..." id="chat-input">
                            <button class="chat-send-btn" id="chat-send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-panel" id="notes-tab">
                    <div class="notes-header-modern">
                        <button id="add-note-btn" class="add-note-btn-modern">
                            <i class="fas fa-plus"></i>
                            Yeni Not Ekle
                        </button>
                    </div>
                    <div class="notes-list-modern" id="notes-list"></div>
                    <div class="note-editor-modern" id="note-editor" style="display:none;">
                        <div class="note-editor-header">
                            <button id="save-note-btn" class="save-note-btn-modern">
                                <i class="fas fa-save"></i>
                                Kaydet
                            </button>
                            <button id="cancel-note-btn" class="cancel-note-btn-modern">
                                <i class="fas fa-times"></i>
                                İptal
                            </button>
                        </div>
                        <textarea id="note-content" class="note-textarea-modern" placeholder="Notunuzu buraya yazın..."></textarea>
                    </div>                </div>

                <!-- Tasks Tab Panel (Kanban Board) -->
                <div class="tab-panel" id="tasks-tab">
                    <div id="kanban-board" class="kanban-content">
                        <div class="kanban-header">
                            <h3>📋 Görev Tahtası</h3>
                            <button id="add-task-btn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Yeni Görev
                            </button>
                        </div>
                        
                        <div class="kanban-container">
                            <div class="kanban-column" data-status="todo">
                                <div class="column-header">
                                    <h4>📝 Yapılacaklar</h4>
                                    <span class="task-count" id="todo-count">0</span>
                                </div>
                                <div class="column-content" id="todo-column">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="kanban-column" data-status="in-progress">
                                <div class="column-header">
                                    <h4>⚡ Devam Ediyor</h4>
                                    <span class="task-count" id="in-progress-count">0</span>
                                </div>
                                <div class="column-content" id="in-progress-column">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="kanban-column" data-status="done">
                                <div class="column-header">
                                    <h4>✅ Tamamlandı</h4>
                                    <span class="task-count" id="done-count">0</span>
                                </div>
                                <div class="column-content" id="done-column">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>                </div>

                <!-- Workflow Tab Panel (BPMN.io Integration) -->
                <div class="tab-panel" id="workflow-tab">
                    <div class="workflow-container">
                        <div class="workflow-header">
                            <div class="workflow-title">
                                <h3><i class="fas fa-project-diagram"></i> İş Akışı Editörü</h3>
                            </div>
                            <div class="workflow-actions">
                                <button id="new-diagram-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Yeni Diyagram
                                </button>
                                <button id="save-diagram-btn" class="btn btn-success" disabled>
                                    <i class="fas fa-save"></i> Kaydet
                                </button>
                                <button id="load-diagram-btn" class="btn btn-secondary">
                                    <i class="fas fa-folder-open"></i> Yükle
                                </button>
                                <button id="export-diagram-btn" class="btn btn-info" disabled>
                                    <i class="fas fa-download"></i> Dışa Aktar
                                </button>
                            </div>
                        </div>
                        
                        <div class="diagram-list-section" id="diagram-list-section">
                            <div class="diagram-list-header">
                                <h4>Mevcut Diyagramlar</h4>
                                <button id="toggle-diagram-list" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="diagram-list" id="diagram-list">
                                <!-- Diagrams will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="bpmn-editor-container">
                            <div class="bpmn-canvas" id="bpmn-canvas">
                                <!-- BPMN.io editor will be rendered here -->
                            </div>
                            <div class="bpmn-properties-panel" id="bpmn-properties-panel">
                                <!-- Properties panel will be rendered here -->
                            </div>
                        </div>
                        
                        <div class="workflow-status" id="workflow-status">
                            <span class="status-text">Hazır</span>
                            <div class="collaboration-indicators" id="collaboration-indicators">
                                <!-- Real-time collaboration indicators -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-panel" id="attendees-tab">
                    <div class="attendees-list-modern" id="attendees-list"></div>
                </div>
            </div>
        </div>    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/bpmn-js@17.7.1/dist/bpmn-modeler.development.js"></script>
    <script src="/js/kanban.js?v=<%= Date.now() %>"></script>
    <script src="/js/bpmn.js?v=<%= Date.now() %>"></script>
    <script src="/js/room.js?v=<%= Date.now() %>"></script>
    
    <script>
        // Odaya geri dönmek için buton
        const dashboardRedirectBtn = document.getElementById('dashboard-redirect-btn');
        if(dashboardRedirectBtn){
            dashboardRedirectBtn.addEventListener('click', () => {
                window.location.href = '/dashboard';
            });
        }

        function copyRoomId() {
            const roomId = "<%= project._id %>";
            navigator.clipboard.writeText(roomId).then(() => {
                // Modern notification
                showNotification("Oda kodu kopyalandı!", "success");
            }).catch(err => {
                console.error('Oda kodu kopyalanamadı: ', err);
                showNotification("Kopyalama başarısız oldu.", "error");
            });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }        // Kanban Board Initialization
        window.roomKanbanBoard = null;
        window.kanbanInitialized = false;
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Only initialize kanban when tasks tab is clicked, not automatically
            const tasksTab = document.querySelector('[data-tab="tasks"]');
            if (tasksTab) {
                tasksTab.addEventListener('click', () => {
                    // Only initialize once and when socket is ready
                    if (!window.kanbanInitialized && window.socket && window.KanbanBoard) {
                        try {
                            console.log('🎯 Initializing Kanban board on first tasks tab click');
                            window.roomKanbanBoard = new KanbanBoard('<%= project._id %>', window.socket);
                            window.kanbanInitialized = true;
                            console.log('✅ Kanban board initialized successfully');
                        } catch (error) {
                            console.error('❌ Kanban initialization failed:', error);
                        }
                    }
                });
            }
        });
    </script>

    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Yeni Görev</h3>
                <span class="close" id="close-task-modal">&times;</span>
            </div>
            <form id="task-form">
                <div class="form-group">
                    <label for="task-title">Görev Başlığı *</label>
                    <input type="text" id="task-title" name="title" required maxlength="200">
                </div>
                
                <div class="form-group">
                    <label for="task-description">Açıklama</label>
                    <textarea id="task-description" name="description" rows="4" maxlength="1000"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-priority">Öncelik</label>
                        <select id="task-priority" name="priority">
                            <option value="low">Düşük</option>
                            <option value="medium" selected>Orta</option>
                            <option value="high">Yüksek</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="task-due-date">Bitiş Tarihi</label>
                        <input type="date" id="task-due-date" name="dueDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="task-assigned-to">Atanan Kişi</label>
                    <select id="task-assigned-to" name="assignedTo">
                        <option value="">Atanmamış</option>
                        <!-- Project members will be loaded here -->
                    </select>
                </div>
                  <div class="form-group">
                    <label for="task-skills">Gereken Yetenekler</label>
                    <input type="text" id="task-skills" name="requiredSkills" 
                           placeholder="JavaScript, React, CSS... (virgülle ayırın)">
                </div>
            </form>
            
            <div class="modal-actions">
                <button type="button" id="cancel-task-btn" class="btn btn-secondary">İptal</button>
                <button type="button" id="save-task-btn" class="btn btn-primary">Kaydet</button>
                <button type="button" id="delete-task-btn" class="btn btn-danger" style="display: none;">Sil</button>
            </div>
        </div>
    </div>

</body>
</html>
